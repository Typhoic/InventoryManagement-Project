<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>All Sales Order</title>
    <link rel="stylesheet" href="/styles/general.css">
    <link rel="stylesheet" href="/styles/sales_order.css">
    <style>
        .table {width:100%;border-collapse:collapse}
        .table th, .table td {padding:10px;border-bottom:1px solid #e6e6e6}
        .topbar {display:flex;justify-content:space-between;align-items:center;margin:16px 0}
        .btn {background:#1e88e5;color:#fff;padding:8px 12px;border-radius:6px;border:none;cursor:pointer}
        .modal {position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center}
        .modal .card {background:#fff;padding:18px;border-radius:8px;min-width:320px}
    </style>
    <script>const API_BASE = location.origin + '/api';</script>
    <script src="/js/dashboard.js" defer></script>
</head>
<body>
    <header class="header">
        <div class="leftsection">
            <img class="logoheader" src="/images/ccb_logo_notext.svg">
        </div>
    </header>
    <main style="padding:20px;margin-top:60px">
        <div class="topbar">
            <h2>All Sales Order</h2>
            <div>
                <button id="filterBtn" class="btn" style="background:#9e9e9e">Filter</button>
                <button id="newOrderBtn" class="btn">+ New</button>
            </div>
        </div>

        <table class="table" id="ordersTable">
            <thead>
                <tr><th>No.</th><th>Date</th><th>Name</th><th>Selling Price</th><th>OrderID</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </main>

    <div id="orderModal" class="modal" style="display:none">
        <div class="card">
            <h3>New Order</h3>
            <form id="orderForm">
                <div>
                    <label>Channel</label>
                    <select name="channel">
                        <option value="dine_in">Dine In</option>
                        <option value="cathering">Cathering</option>
                        <option value="go_food">Go Food</option>
                        <option value="grab_food">Grab Food</option>
                    </select>
                </div>
                <div style="margin-top:8px">
                    <label>Menu Item</label>
                    <select id="menuSelect"></select>
                </div>
                <div style="margin-top:8px">
                    <label>Quantity</label>
                    <input type="number" name="quantity" value="1" min="1">
                </div>
                <div style="margin-top:8px">
                    <label>Status</label>
                    <select name="status"><option value="pending">Pending</option><option value="completed">Completed</option></select>
                </div>
                <div style="margin-top:10px;text-align:right">
                    <button type="button" id="cancelOrder" class="btn" style="background:#9e9e9e">Cancel</button>
                    <button type="submit" class="btn">Create</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const api = (typeof API_BASE !== 'undefined') ? API_BASE : location.origin + '/api';
        console.log('API Base:', api);
        const tbody = document.querySelector('#ordersTable tbody');
        const orderModal = document.getElementById('orderModal');
        const newOrderBtn = document.getElementById('newOrderBtn');
        const cancelOrder = document.getElementById('cancelOrder');
        const menuSelect = document.getElementById('menuSelect');

        async function loadOrders(){
            try {
                console.log('Loading orders from:', api + '/orders');
                const res = await fetch(api + '/orders');
                if (!res.ok) throw new Error('Failed to load orders: ' + res.status);
                const json = await res.json();
                const orders = json.data || [];
                tbody.innerHTML = '';
                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">No orders found</td></tr>';
                    return;
                }
                orders.forEach((o, idx) => {
                    const tr = document.createElement('tr');
                    const date = new Date(o.created_at).toLocaleDateString('id-ID');
                    const name = (o.orderItems && o.orderItems[0] && o.orderItems[0].menu_item) ? o.orderItems[0].menu_item.name : '-';
                    const price = (o.total_amount) ? 'Rp' + Number(o.total_amount).toLocaleString('id-ID') : '-';
                    tr.innerHTML = `<td>${idx+1}.</td><td>${date}</td><td>${name}</td><td>${price}</td><td>${o.id}</td>`;
                    tbody.appendChild(tr);
                });
                console.log('Orders loaded:', orders.length);
            } catch(e) {
                console.error('Error loading orders:', e);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:red">Error loading orders</td></tr>';
            }
        }

        async function loadMenuItems(){
            try {
                console.log('Loading menu items from:', api + '/menu-items');
                const res = await fetch(api + '/menu-items');
                console.log('Menu items response:', res.status, res.statusText);
                if (!res.ok) throw new Error('Failed to load menu items: ' + res.status + ' ' + res.statusText);
                const json = await res.json();
                console.log('Menu items JSON:', json);
                const items = json.data || [];
                menuSelect.innerHTML = '';
                if (items.length === 0) {
                    menuSelect.innerHTML = '<option>No menu items available</option>';
                    console.warn('No menu items found in response');
                    return;
                }
                items.forEach(it => {
                    const opt = document.createElement('option');
                    opt.value = it.id;
                    opt.textContent = it.name + ' - Rp' + (it.price || 0).toLocaleString('id-ID');
                    menuSelect.appendChild(opt);
                });
                console.log('Menu items loaded:', items.length);
            } catch(e) {
                console.error('Error loading menu items:', e);
                menuSelect.innerHTML = '<option>Error loading menu items</option>';
            }
        }

        newOrderBtn.addEventListener('click', ()=>{ orderModal.style.display='flex'; });
        cancelOrder.addEventListener('click', ()=>{ orderModal.style.display='none'; });

        document.getElementById('orderForm').addEventListener('submit', async (e)=>{
            e.preventDefault();
            const form = e.target;
            const channel = form.channel.value;
            const status = form.status.value;
            const menu_item_id = parseInt(menuSelect.value, 10);
            const quantity = parseInt(form.quantity.value, 10) || 1;
            
            if (!menu_item_id || isNaN(menu_item_id)) {
                alert('Please select a menu item');
                return;
            }

            try {
                const resItem = await fetch(api + '/menu-items/' + menu_item_id);
                if (!resItem.ok) throw new Error('Menu item not found');
                const jsonItem = await resItem.json();
                const price = jsonItem.data ? jsonItem.data.price : 0;
                const total_amount = price * quantity;

                const payload = { channel, status, total_amount, items: [{ menu_item_id, quantity, price }] };
                const res = await fetch(api + '/orders', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
                
                if (res.status === 201) {
                    alert('Order created successfully');
                    orderModal.style.display = 'none';
                    form.reset();
                    loadOrders();
                } else {
                    const j = await res.json();
                    alert('Error creating order: ' + (j.message || 'Unknown error'));
                    console.error('Order creation error:', j);
                }
            } catch(err) {
                alert('Error: ' + err.message);
                console.error('Order creation error:', err);
            }
        });

        // Initialize on page load - defer slightly to ensure DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, initializing...');
            loadMenuItems();
            loadOrders();
        });
    </script>
</body>
</html>
