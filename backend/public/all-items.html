<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>All Items</title>
    <link rel="stylesheet" href="/styles/general.css">
    <link rel="stylesheet" href="/styles/header.css">
    <style>
        .table {width:100%;border-collapse:collapse}
        .table th, .table td {padding:10px;border-bottom:1px solid #e6e6e6}
        .topbar {display:flex;justify-content:space-between;align-items:center;margin:16px 0}
        .btn {background:#1e88e5;color:#fff;padding:8px 12px;border-radius:6px;border:none;cursor:pointer}
        .modal {position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center}
        .modal .card {background:#fff;padding:18px;border-radius:8px;min-width:320px}
        .item-image {width:48px;height:48px;object-fit:cover;border-radius:4px}
    </style>
    <script>const API_BASE = location.origin + '/api';</script>
    <script src="/js/dashboard.js" defer></script>
</head>
<body>
    <header class="header">
        <div class="leftsection">
            <img class="logoheader" src="/images/ccb_logo_notext.svg">
        </div>
    </header>
    <main style="padding:20px;margin-top:60px">
        <div class="topbar">
            <h2>All Items</h2>
            <div>
                <button id="filterBtn" class="btn" style="background:#9e9e9e">Filter</button>
                <button id="newItemBtn" class="btn">+ New</button>
            </div>
        </div>

        <table class="table" id="itemsTable">
            <thead>
                <tr><th>No.</th><th>Name</th><th>Type</th><th>Selling Price</th><th>Description</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </main>

    <div id="itemModal" class="modal" style="display:none">
        <div class="card">
            <h3>New Item (Menu Item)</h3>
            <form id="itemForm">
                <div><label>Name</label><input name="name" required></div>
                <div><label>Price</label><input name="price" type="number" min="0" step="0.01" required></div>
                <div><label>Description</label><textarea name="description"></textarea></div>
                <div><label>Image URL (optional)</label><input name="image_url" placeholder="/images/item.jpg"></div>
                <div style="margin-top:10px;text-align:right">
                    <button type="button" id="cancelItem" class="btn" style="background:#9e9e9e">Cancel</button>
                    <button type="submit" class="btn">Create</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const api = (typeof API_BASE !== 'undefined') ? API_BASE : location.origin + '/api';
        console.log('API Base:', api);
        const tbody = document.querySelector('#itemsTable tbody');
        const itemModal = document.getElementById('itemModal');
        const newItemBtn = document.getElementById('newItemBtn');
        const cancelItem = document.getElementById('cancelItem');

        async function loadItems(){
            try {
                console.log('Loading items from:', api + '/menu-items');
                const res = await fetch(api + '/menu-items');
                console.log('Items response:', res.status, res.statusText);
                if (!res.ok) throw new Error('Failed to load items: ' + res.status + ' ' + res.statusText);
                const json = await res.json();
                console.log('Items JSON:', json);
                const items = json.data || [];
                tbody.innerHTML = '';
                if (items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">No items found</td></tr>';
                    console.warn('No items found in response');
                    return;
                }
                items.forEach((it, idx) => {
                    const tr = document.createElement('tr');
                    const img = it.image_url ? `<img class="item-image" src="${it.image_url}" onerror="this.style.display='none'">` : '';
                    tr.innerHTML = `<td>${idx+1}.</td><td>${img} ${it.name}</td><td>Product</td><td>Rp${(it.price||0).toLocaleString('id-ID')}</td><td>${(it.description||'')}</td>`;
                    tbody.appendChild(tr);
                });
                console.log('Items loaded:', items.length);
            } catch(e) {
                console.error('Error loading items:', e);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:red">Error loading items</td></tr>';
            }
        }

        newItemBtn.addEventListener('click', ()=>{ itemModal.style.display='flex'; });
        cancelItem.addEventListener('click', ()=>{ itemModal.style.display='none'; });

        document.getElementById('itemForm').addEventListener('submit', async (e)=>{
            e.preventDefault();
            const form = e.target;
            
            if (!form.name.value.trim()) {
                alert('Item name is required');
                return;
            }
            
            const price = parseFloat(form.price.value);
            if (isNaN(price) || price < 0) {
                alert('Please enter a valid price');
                return;
            }

            const payload = {
                name: form.name.value.trim(),
                price: price,
                description: form.description.value.trim(),
                image_url: form.image_url.value.trim()
            };

            try {
                const res = await fetch(api + '/menu-items', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                if (res.status === 201) {
                    alert('Item created successfully');
                    itemModal.style.display = 'none';
                    form.reset();
                    loadItems();
                } else {
                    const j = await res.json();
                    alert('Error creating item: ' + (j.message || 'Unknown error'));
                    console.error('Item creation error:', j);
                }
            } catch(err) {
                alert('Error: ' + err.message);
                console.error('Item creation error:', err);
            }
        });

        // Initialize on page load - defer slightly to ensure DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, initializing...');
            loadItems();
        });
    </script>
</body>
</html>
